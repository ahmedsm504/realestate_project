{% extends 'base.html' %}
{% load static %}

{% block title %}قائمة العقارات{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/property_list.css' %}">
{% endblock %}

{% block content %}
<div class="property-container">
    <header class="hero-header">
        <div class="hero-content">
            <h1 class="hero-title">🏡 اكتشف أفضل العقارات</h1>
            <p class="hero-subtitle">ابحث في آلاف العقارات المميزة واعثر على منزلك القادم.</p>
        </div>
    </header>

    <form method="GET" action="{% url 'properties:property_list' %}" id="filters-form" class="filters-section">
        <div class="main-search-container">
            <div class="search-box">
                <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <input type="text" id="main-search-input" name="q" class="main-search-input" placeholder="ابحث بالعنوان، المدينة، أو المنطقة..." value="{{ request.GET.q }}" autocomplete="off">
            </div>
            <button type="submit" class="search-button">بحث</button>
        </div>

        <div class="filters-header">
            <h2 class="filters-title">فلترة متقدمة</h2>
            <button type="button" id="toggle-filters-btn" class="toggle-filters-btn" aria-expanded="false" aria-controls="filters-content">
                <span>إظهار الفلاتر</span>
                <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <div class="filters-content" id="filters-content">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="city_search" class="filter-label">المدينة</label>
                    <input type="text" name="city_search" id="city_search" placeholder="كل المدن" value="{{ request.GET.city_search }}" class="filter-input">
                </div>

                <div class="filter-group">
                    <label for="property_type" class="filter-label">نوع العقار</label>
                    <select name="property_type" id="property_type" class="filter-select">
                        <option value="">جميع الأنواع</option>
                        {% for value, text in property_type_choices %}
                            <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ text }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="status" class="filter-label">الحالة</label>
                    <select name="status" id="status" class="filter-select">
                        <option value="">جميع الحالات</option>
                        {% for value, text in property_status_choices %}
                            <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ text }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="bedrooms" class="filter-label">غرف النوم</label>
                    <select name="bedrooms" id="bedrooms" class="filter-select">
                        <option value="">أي عدد</option>
                        <option value="1" {% if request.GET.bedrooms == '1' %}selected{% endif %}>1</option>
                        <option value="2" {% if request.GET.bedrooms == '2' %}selected{% endif %}>2</option>
                        <option value="3" {% if request.GET.bedrooms == '3' %}selected{% endif %}>3</option>
                        <option value="4" {% if request.GET.bedrooms == '4' %}selected{% endif %}>4</option>
                        <option value="5" {% if request.GET.bedrooms == '5' %}selected{% endif %}>+5</option>
                    </select>
                </div>

                <div class="filter-group range-filter">
                    <label class="filter-label">نطاق السعر (ج.م)</label>
                    <div class="range-inputs">
                        <input type="number" name="min_price" placeholder="من" value="{{ request.GET.min_price }}" class="filter-input" min="0">
                        <span>-</span>
                        <input type="number" name="max_price" placeholder="إلى" value="{{ request.GET.max_price }}" class="filter-input" min="0">
                    </div>
                </div>

                <div class="filter-group range-filter">
                    <label class="filter-label">المساحة (م²)</label>
                    <div class="range-inputs">
                        <input type="number" name="min_area" placeholder="من" value="{{ request.GET.min_area }}" class="filter-input" min="0">
                        <span>-</span>
                        <input type="number" name="max_area" placeholder="إلى" value="{{ request.GET.max_area }}" class="filter-input" min="0">
                    </div>
                </div>
            </div>
            <div class="filters-actions">
                <button type="submit" class="apply-filters-btn">تطبيق الفلاتر</button>
                <a href="{% url 'properties:property_list' %}" class="clear-filters-btn">مسح الكل</a>
            </div>
        </div>
    </form>

    <main class="results-section" id="results-section">
        <div class="results-header">
            <div class="results-info">
                <h3 class="results-title">العقارات المتاحة</h3>
                <p class="results-count">تم العثور على <strong>{{ page_obj.paginator.count }}</strong> عقار</p>
            </div>
            <div class="view-toggle">
                <button type="button" class="view-btn" data-view="grid" title="عرض شبكي">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path d="M4 5C4 4.44772 4.44772 4 5 4H8C8.55228 4 9 4.44772 9 5V8C9 8.55228 8.55228 9 8 9H5C4.44772 9 4 8.55228 4 8V5Z" stroke="currentColor" stroke-width="2"/><path d="M15 5C15 4.44772 15.4477 4 16 4H19C19.5523 4 20 4.44772 20 5V8C20 8.55228 19.5523 9 19 9H16C15.4477 9 15 8.55228 15 8V5Z" stroke="currentColor" stroke-width="2"/><path d="M4 16C4 15.4477 4.44772 15 5 15H8C8.55228 15 9 15.4477 9 16V19C9 19.5523 8.55228 20 8 20H5C4.44772 20 4 19.5523 4 19V16Z" stroke="currentColor" stroke-width="2"/><path d="M15 16C15 15.4477 15.4477 15 16 15H19C19.5523 15 20 15.4477 20 16V19C20 19.5523 19.5523 20 19 20H16C15.4477 20 15 19.5523 15 19V16Z" stroke="currentColor" stroke-width="2"/></svg>
                </button>
                <button type="button" class="view-btn" data-view="list" title="عرض قائمة">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 6H21M8 12H21M8 18H21M3 6H3.01M3 12H3.01M3 18H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>

        {% if properties %}
            <div id="property-results" class="property-grid">
                {% for item in properties %}
                    {% with property=item.property %}
                    <article class="property-card">
                        <div class="property-image-container">
                            <a href="{% if property.slug %}{% url 'properties:property_detail' property.slug %}{% else %}{% url 'properties:property_detail' property.pk %}{% endif %}">
                                <img src="{{ item.display_image_url }}" alt="{{ property.title }}" class="property-image" loading="lazy">
                            </a>
                            <div class="property-badges">
                                <span class="property-type-badge">{{ property.get_property_type_display }}</span>
                                <span class="property-status-badge {{ property.status }}">{{ property.get_status_display }}</span>
                            </div>
                        </div>
                        <div class="property-content">
                            <div class="property-header">
                                <a href="{% if property.slug %}{% url 'properties:property_detail' property.slug %}{% else %}{% url 'properties:property_detail' property.pk %}{% endif %}" class="property-title">{{ property.title }}</a>
                                <div class="property-price">{{ property.price|floatformat:"0" }} ج.م</div>
                            </div>
                            <div class="property-location">
                                <svg class="location-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                <span>{{ property.location_address|truncatechars:40 }}, {{ property.city }}</span>
                            </div>
                            <div class="property-features">
                                <div class="feature">🛏️ <span>{{ property.bedrooms|default:"--" }} غرف</span></div>
                                <div class="feature">🛁 <span>{{ property.bathrooms|default:"--" }} حمام</span></div>
                                <div class="feature">🏠 <span>{{ property.area|floatformat:"0"|default:"--" }} م²</span></div>
                            </div>
                        </div>
                    </article>
                    {% endwith %}
                {% endfor %}
            </div>

            {% if page_obj.paginator.num_pages > 1 %}
                <nav class="pagination-container" aria-label="صفحات النتائج">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="pagination-link">السابق</a>
                    {% endif %}
                    <span class="pagination-current">صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="pagination-link">التالي</a>
                    {% endif %}
                </nav>
            {% endif %}

        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">😔</div>
                <h3 class="empty-state-title">لا توجد عقارات مطابقة لبحثك</h3>
                <p class="empty-state-subtitle">حاول تغيير معايير البحث أو مسح الفلاتر.</p>
                <a href="{% url 'properties:property_list' %}" class="btn-primary">عرض جميع العقارات</a>
            </div>
        {% endif %}
    </main>
</div>

<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<button id="scroll-to-top" class="scroll-top-btn" title="العودة للأعلى">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/property_list.js' %}" defer></script>

<script>


    // static/js/property_list.js

document.addEventListener('DOMContentLoaded', () => {
    // --- Initialize all functionalities ---
    initFilterToggle();
    initViewToggle();
    initScrollToTop();
    initFormSubmissionLoader();
});

/**
 * Handles the logic for showing and hiding the advanced filters section.
 */
function initFilterToggle() {
    const toggleBtn = document.getElementById('toggle-filters-btn');
    const filtersContent = document.getElementById('filters-content');

    if (!toggleBtn || !filtersContent) return;

    // Check if any filters are active on page load to show the filters by default
    const urlParams = new URLSearchParams(window.location.search);
    const filterKeys = ['city_search', 'property_type', 'status', 'bedrooms', 'min_price', 'max_price', 'min_area', 'max_area'];
    const hasActiveFilters = filterKeys.some(key => urlParams.has(key) && urlParams.get(key) !== '');

    if (hasActiveFilters) {
        toggleFilters(true);
    }
    
    toggleBtn.addEventListener('click', () => {
        const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleFilters(!isExpanded);
    });

    function toggleFilters(show) {
        if (show) {
            filtersContent.classList.add('is-open');
            toggleBtn.setAttribute('aria-expanded', 'true');
            toggleBtn.querySelector('span').textContent = 'إخفاء الفلاتر';
        } else {
            filtersContent.classList.remove('is-open');
            toggleBtn.setAttribute('aria-expanded', 'false');
            toggleBtn.querySelector('span').textContent = 'إظهار الفلاتر';
        }
    }
}

/**
 * Handles switching between grid and list view for properties.
 * Saves the user's preference in localStorage.
 */
function initViewToggle() {
    const viewToggleContainer = document.querySelector('.view-toggle');
    const resultsContainer = document.getElementById('property-results');
    
    if (!viewToggleContainer || !resultsContainer) return;
    
    const viewButtons = viewToggleContainer.querySelectorAll('.view-btn');
    const savedView = localStorage.getItem('property_view') || 'grid';

    function setView(view) {
        if (view === 'list') {
            resultsContainer.classList.remove('property-grid');
            resultsContainer.classList.add('property-list');
        } else {
            resultsContainer.classList.remove('property-list');
            resultsContainer.classList.add('property-grid');
        }

        viewButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });

        localStorage.setItem('property_view', view);
    }

    viewButtons.forEach(button => {
        button.addEventListener('click', () => {
            setView(button.dataset.view);
        });
    });

    // Set initial view on page load
    setView(savedView);
}

/**
 * Handles the "scroll to top" button visibility and functionality.
 */
function initScrollToTop() {
    const scrollTopBtn = document.getElementById('scroll-to-top');

    if (!scrollTopBtn) return;
    
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.classList.add('is-visible');
        } else {
            scrollTopBtn.classList.remove('is-visible');
        }
    });

    scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

/**
 * Shows a loading overlay whenever the filter form is submitted.
 */
function initFormSubmissionLoader() {
    const form = document.getElementById('filters-form');
    const loadingOverlay = document.getElementById('loading-overlay');

    if (!form || !loadingOverlay) return;

    form.addEventListener('submit', () => {
        loadingOverlay.classList.add('is-visible');
    });
    
    // Hide loader if user navigates back using browser buttons
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
             loadingOverlay.classList.remove('is-visible');
        }
    });
}
</script>


{% endblock %}