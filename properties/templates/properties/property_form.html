{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}تعديل عقار{% else %}إضافة عقار جديد{% endif %}
{% endblock %}
{% block content %}
<div class="min-h-screen p-4 md:p-8 bg-gradient-to-br from-gray-100/50 to-blue-50/50 flex items-center justify-center">
    <div class="max-w-4xl mx-auto w-full p-8 bg-white/60 backdrop-blur-md rounded-3xl shadow-2xl my-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-2 drop-shadow-sm">
            {% if form.instance.pk %}تعديل العقار{% else %}أضف عقار جديد{% endif %}
        </h1>
        <p class="text-center text-gray-700 mb-8 text-lg">
            {% if form.instance.pk %}تعديل بيانات {{ form.instance.title }}{% else %}املأ البيانات التالية لإضافة عقار جديد لقائمتك.{% endif %}
        </p>

        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            {% if form.errors %}
                <div class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 rounded-md mb-6 animate-pulse" role="alert">
                    <strong class="font-bold">خطأ في الإدخال!</strong>
                    <span class="block sm:inline">الرجاء تصحيح الأخطاء التالية في النموذج:</span>
                    <ul class="mt-2 list-disc list-inside">
                        {% for field in form %}
                            {% if field.errors %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        {% if form.non_field_errors %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- حقل الصورة الرئيسية -->
                <div class="md:col-span-2">
                    <label for="id_main_image" class="block text-gray-800 font-bold mb-2">الصورة الرئيسية للعقار</label>
                    <input type="file" name="{{ form.main_image.name }}" id="id_main_image" class="file:rounded-xl file:py-2 file:px-4 file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:transition-colors file:duration-300 block w-full text-sm text-gray-700 bg-white/70 backdrop-blur-sm rounded-xl border border-gray-300 cursor-pointer shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" accept="image/*">
                    {% if form.instance.pk and main_image %}
                        <div class="mt-4 flex items-center gap-4 p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-inner border border-gray-200">
                            <img src="{{ main_image.image.url }}" alt="الصورة الرئيسية الحالية" class="w-24 h-24 object-cover rounded-xl shadow-md">
                            <div>
                                <p class="text-md font-semibold text-gray-700">الصورة الرئيسية الحالية</p>
                                <p class="text-sm text-gray-500">سيتم استبدالها بالصورة الجديدة عند الحفظ.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- حقول الإدخال الأساسية -->
                {% for field in form %}
                    {% if field.name != 'main_image' and field.name != 'images' and field.name != 'new_features' and field.name != 'features' and field.name != 'latitude' and field.name != 'longitude' %}
                        <div class="form-group {% if field.name == 'description' or field.name == 'location_address' %}md:col-span-2{% endif %}">
                            <label for="{{ field.id_for_label }}" class="block text-gray-800 font-bold mb-2">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}<p class="text-sm text-gray-500 mt-1">{{ field.help_text }}</p>{% endif %}
                            {% for error in field.errors %}<p class="text-red-500 text-sm mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- حقل المميزات -->
                <div class="md:col-span-2">
                    <label class="block text-gray-800 font-bold mb-2">{{ form.features.label }}</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-inner border border-gray-200">
                        {% for checkbox in form.features %}
                            <label for="{{ checkbox.id_for_label }}" class="flex items-center p-3 rounded-lg shadow-sm border border-gray-300/50 hover:shadow-md transition-shadow duration-200 cursor-pointer bg-white/50 has-[:checked]:bg-blue-100/60 has-[:checked]:border-blue-500/80">
                                {{ checkbox.tag }}
                                <span class="mr-3 text-gray-700 font-medium cursor-pointer">{{ checkbox.choice_label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                    {% for error in form.features.errors %}<p class="text-red-500 text-sm mt-1">{{ error }}</p>{% endfor %}
                </div>

                <!-- حقل مميزات جديدة -->
                <div class="md:col-span-2">
                    <label for="{{ form.new_features.id_for_label }}" class="block text-gray-800 font-bold mb-2">{{ form.new_features.label }}</label>
                    {{ form.new_features }}
                    {% if form.new_features.help_text %}<p class="text-sm text-gray-500 mt-1">{{ form.new_features.help_text }}</p>{% endif %}
                    {% for error in form.new_features.errors %}<p class="text-red-500 text-sm mt-1">{{ error }}</p>{% endfor %}
                </div>

                <!-- قسم الخريطة -->
                <div class="md:col-span-2 p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">تحديد موقع العقار على الخريطة</h3>
                    <p class="text-gray-600 mb-4">اسحب العلامة لتحديد الموقع الدقيق، أو انقر على الخريطة لوضع علامة جديدة.</p>
                    <div id="map-picker" class="w-full h-96 rounded-2xl shadow-inner border border-gray-300"></div>
                    
                    {# حقول خطوط الطول والعرض المخفية #}
                    {{ form.latitude }}
                    {{ form.longitude }}
                </div>

                <!-- صور العقار الإضافية -->
                {% if form.instance.pk %}
                    <div class="md:col-span-2 border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">الصور الإضافية الحالية:</h3>
                        {% if extra_images %}
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for img in extra_images %}
                                    <div class="relative group">
                                        <img src="{{ img.image.url }}" alt="صورة العقار" class="w-full h-32 object-cover rounded-xl shadow-md">
                                        <button type="submit" name="delete_image_{{ img.id }}" value="{{ img.id }}" 
                                                class="absolute top-2 left-2 bg-red-600 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hover:bg-red-700" 
                                                onclick="return confirm('هل أنت متأكد من حذف هذه الصورة؟')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-gray-500">لا توجد صور إضافية حاليًا.</p>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- حقل رفع الصور الإضافية الجديدة -->
                <div class="md:col-span-2">
                    <label for="id_images" class="block text-gray-800 font-bold mb-2">صور العقار الإضافية</label>
                    <input type="file" name="{{ form.images.name }}" id="{{ form.images.id_for_label }}" multiple class="file:rounded-xl file:py-2 file:px-4 file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:transition-colors file:duration-300 block w-full text-sm text-gray-700 bg-white/70 backdrop-blur-sm rounded-xl border border-gray-300 cursor-pointer shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" accept="image/*">
                </div>
            </div>

            <!-- أزرار الإجراءات -->
            <div class="flex justify-center gap-6 mt-12">
                <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold py-3 px-10 rounded-2xl shadow-xl hover:from-blue-700 hover:to-blue-900 transition-all duration-300 transform hover:scale-105">
                    {% if form.instance.pk %}تحديث العقار{% else %}إضافة {% endif %}
                </button>
                <a href="{% url 'properties:my_properties' %}" class="bg-gray-300 text-gray-800 font-bold py-3 px-10 rounded-2xl shadow-lg hover:bg-gray-400 transition-all duration-300 transform hover:scale-105">
                    إلغاء
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // كود JavaScript لخرائط Google في فورم الإضافة/التعديل
        const latitudeField = document.getElementById('id_latitude');
        const longitudeField = document.getElementById('id_longitude');
        const mapDiv = document.getElementById('map-picker');

        if (mapDiv) { // تأكد من أن عنصر الخريطة موجود
            window.initMapPicker = function() { // جعل الدالة متاحة عالمياً
                // استخدام القيم الموجودة في الحقول أو قيم افتراضية (القاهرة)
                const defaultLat = parseFloat(latitudeField.value) || 30.0444; 
                const defaultLng = parseFloat(longitudeField.value) || 31.2357;
                const initialLocation = { lat: defaultLat, lng: defaultLng };

                const map = new google.maps.Map(mapDiv, {
                    zoom: 12, // مستوى التكبير الافتراضي
                    center: initialLocation, // مركز الخريطة هو الموقع الحالي أو الافتراضي
                });

                let marker = new google.maps.Marker({
                    position: initialLocation,
                    map: map,
                    draggable: true, // يمكن سحب العلامة
                    title: "موقع العقار",
                });

                // تحديث الحقول عند سحب العلامة
                marker.addListener('dragend', function() {
                    latitudeField.value = marker.getPosition().lat();
                    longitudeField.value = marker.getPosition().lng();
                });

                // تحديث العلامة والحقول عند النقر على الخريطة
                map.addListener('click', function(event) {
                    marker.setPosition(event.latLng);
                    latitudeField.value = event.latLng.lat();
                    longitudeField.value = event.latLng.lng();
                });
            };


    const GOOGLE_MAPS_API_KEY = "{{ GOOGLE_MAPS_API_KEY }}";

    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMapPicker`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);



        }
    });
</script>

<style>
    /* تطبيق التنسيق على حقول النموذج */
    .form-group input:not([type="checkbox"]),
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        transition: all 0.2s;
        background-color: rgba(255, 255, 255, 0.7); /* شفافة أكثر */
        backdrop-filter: blur(8px);
    }

    .form-group input:not([type="checkbox"]):focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6; /* focus:border-blue-500 */
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
        background-color: rgba(255, 255, 255, 0.178); /* تصبح أقل شفافية عند التركيز */
    }

    /* تنسيق خاص لحقل الوصف */
    textarea {
        resize: vertical;
    }
    
    /* تنسيق checkbox المميزات */
    [type="checkbox"] {
        width: 1.25rem; /* w-5 */
        height: 1.25rem; /* h-5 */
        border-radius: 0.25rem; /* rounded */
        border: 1px solid #d1d5db;
        background-color: #fff;
        appearance: none; /* إخفاء المظهر الافتراضي للمتصفح */
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
    }

    /* تنسيق مربع الاختيار عند التحديد */
    [type="checkbox"]:checked {
        background-color: #2563eb; /* bg-blue-600 */
        border-color: #2563eb;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 12L11 14L15 10' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
{% endblock %}
